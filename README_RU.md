[English](README.md) | [Русский](README_RU.md)

---

# ⚠️ ПРЕДОСТЕРЕЖЕНИЕ - ИСПОЛЬЗУЙТЕ НА СВОЙ СТРАХ И РИСК ⚠️

**ЭТО ПРОГРАММНОЕ ОБЕСПЕЧЕНИЕ НЕ БЫЛО ТЕСТИРОВАНО НА РЕАЛЬНЫХ 3D-ПРИНТЕРАХ.**

Значения компенсации и вычисления являются теоретическими и основаны на ограниченном тестировании. Использование этого скрипта может привести к:
- **Переэкструзии**, что приведёт к плохому качеству печати, пробкам в сопле или повреждению принтера
- **Недостаточной экструзии**, если значения компенсации неправильны для вашей конфигурации
- **Ошибкам в G-коде**, которые могут привести к сбою печати

**АВТОР НЕ НЕСЁТ ОТВЕТСТВЕННОСТИ И НЕ ОТВЕЧАЕТ ЗА ЛЮБОЙ УЩЕРБ ВАШЕМУ ПРИНТЕРУ, МАТЕРИАЛАМ ИЛИ ИМУЩЕСТВУ, ВЫЗВАННЫЙ ИСПОЛЬЗОВАНИЕМ ЭТОГО ПРОГРАММНОГО ОБЕСПЕЧЕНИЯ.**

Всегда тестируйте сначала на небольших печатях, внимательно следите за процессом печати и убедитесь, что результаты соответствуют вашим ожиданиям.

---

# Flow Compensator для Prusa Slicer

Пост-обработка скрипт для Prusa Slicer, который динамически компенсирует недостаточную экструзию на высоких объёмных расходаъ. Использует **PCHIP интерполяцию** (монотонный кубический сплайн) для создания плавных кривых компенсации без выбросов или пульсаций.

## Зачем это нужно?

Высокоскоростные хотенды (Goliath, Rapido HF, Dragon HF, Revo CR и др.) испытывают нелинейную недостаточную экструзию на высоких скоростях потока:

| Скорость потока | Недостаточная экструзия |
|-----------------|------------------------|
| 10 мм³/с        | ~0%                    |
| 30 мм³/с        | ~6%                    |
| 50 мм³/с        | ~11%                   |
| 60 мм³/с        | ~15% (сильно)          |

Этот скрипт автоматически рассчитывает скорость потока для каждой команды экструзии G1 и применяет динамическую компенсацию на основе настраиваемых профилей материалов.

## Установка

1. Клонируйте или скачайте репозиторий:
```bash
git clone https://github.com/yourusername/flow-compensator.git
cd flow-compensation
```

2. Установите зависимости Python:
```bash
pip install -r requirements.txt
```

Требуется: Python 3.7+, PyYAML>=6.0, scipy>=1.9.0, numpy>=1.21.0

Желательно: gcodeparser>=1.0 (предоставляет парсинг на основе библиотеки)

## Быстрый старт

### Командная строка

```bash
# Автоматическое определение материала из G-кода
python flow_compensator.py input.gcode output.gcode

# Указать материал явно
python flow_compensator.py --material PETG input.gcode output.gcode

# Мульти-материал IDEX (материалы сопоставляются с T0, T1, ...)
python flow_compensator.py input.gcode output.gcode PETG PVA PLA

# Dry run (анализ без изменения файла)
python flow_compensator.py --dry-run input.gcode

# Использовать пользовательский конфиг
python flow_compensator.py --config my_profile.yaml input.gcode output.gcode

# Использовать regex-парсер (для тестирования/сравнения)
python flow_compensator.py --parser regex input.gcode output.gcode

# Подробный режим - показать детальную информацию об обработке
python flow_compensator.py --verbose input.gcode output.gcode

# Отключить комментарии компенсации
python flow_compensator.py --no-comments input.gcode output.gcode
```

### Интеграция с Prusa Slicer

**Print Settings → Output Options → Post-processing scripts**

**Одна головка (автоопределение):**
```
python.exe "C:\path\to\flow_compensator.py" --config "C:\path\to\config.yaml" --material {filament_type[0]} "[output_filepath]"
```

**Мульти-материал IDEX (автоматическое сопоставление T0/T1):**
```
python.exe "C:\path\to\flow_compensator.py" --config "C:\path\to\config.yaml" "[output_filepath]" {filament_type[0]} {filament_type[1]}
```

**С подробным выводом:**
```
python.exe "C:\path\to\flow_compensator.py" --config "C:\path\to\config.yaml" --verbose "[output_filepath]"
```

**Без комментариев компенсации:**
```
python.exe "C:\path\to\flow_compensator.py" --config "C:\path\to\config.yaml" --no-comments "[output_filepath]"
```

**Linux/macOS:**
```
python3 /path/to/flow_compensator.py --config /path/to/config.yaml --material {filament_type[0]} "[output_filepath]"
```

## Конфигурация

### Профили материалов

Отредактируйте `config.yaml` для настройки кривых компенсации:

```yaml
materials:
  PETG:
    name: "PETG"
    curve_points:
      - [0, 1.00]    # [скорость_потока_мм3_с, множитель]
      - [10, 1.00]   # Без компенсации ниже 10 мм³/с
      - [20, 1.02]   # +2% при 20 мм³/с
      - [30, 1.06]   # +6% при 30 мм³/с
      - [40, 1.10]   # +10% при 40 мм³/с
      - [50, 1.13]   # +13% при 50 мм³/с
      - [60, 1.18]   # +18% при 60 мм³/с
```

### Создание собственного профиля

1. Распечатайте тест скорости потока (например, [Сnckitchen Flow Test](https://www.cnckitchen.com/blog/extrusion-system-benchmark-tool-for-fast-prints))
2. Измерьте недостаточную экструзию при различных объемах экструзии
3. Рассчитайте компенсацию пример: если -10% недостаточной экструзии при 50 мм³/с, используйте множитель = 1.10
4. Добавьте точки кривой в `config.yaml`

### Пределы безопасности

```yaml
output:
  min_compensation: 0.8   # Никогда не уменьшать ниже 80%
  max_compensation: 1.5   # Никогда не увеличивать выше 150%
```

### Настройка мульти-материала

**Вариант 1: Настроить в config.yaml**
```yaml
extruder_mapping:
  T0: PETG   # Инструмент 0 - Основная модель
  T1: PVA    # Инструмент 1 - Растворимая поддержка
  T2: PLA    # Инструмент 2 - Второй материал
```

**Вариант 2: Командная строка (рекомендуется для IDEX)**
```bash
python flow_compensator.py input.gcode output.gcode PETG PVA PLA ABS
```
Материалы автоматически сопоставляются с T0, T1, T2, T3. Редактирование конфига не требуется!

## Режимы парсинга

Скрипт поддерживает два режима парсинга G-кода:

### Парсер gcodeparser (Рекомендуется)
Использует библиотеку `gcodeparser` для надёжного парсинга:
- Обрабатывает особые случаи и специальные форматы G-кода
- Более надёжное извлечение метаданных
- Лучшая производительность для больших файлов
- Требует `pip install gcodeparser`

### Regex парсер
Использует регулярные выражения для парсинга:
- Не требует дополнительных зависимостей
- Быстрее для простых файлов G-кода
- Полезен для тестирования и разработки
- Автоматически переключается, если gcodeparser не установлен

Используйте `--parser library` или `--parser regex` для выбора режима.

## Как это работает

### Расчёт скорости потока

```
скорость_потока = (кол_экструзии × площадь_филамента / расстояние_перемещения) × скорость_подачи / 60
```

Где:
- `кол_экструзии`: изменение значения E в мм
- `площадь_филамента`: π × (диаметр/2)²
- `расстояние_перемещения`: расстояние перемещения XYZ в мм
- `скорость_подачи`: значение F в мм/мин
- Результат: мм³/с

### Применение компенсации

1. Рассчитать скорость потока для каждой команды экструзии
2. Найти множитель из кривой сплайна PCHIP
3. Применить к экструзии: `новый_E = старый_E × множитель`
4. Ограничить пределами безопасности (0.8x - 1.5x)
5. Добавить комментарий: `G1 X... E... ; flow_comp: 45.2мм³/с ×1.100`

### Почему PCHIP?

**PCHIP (Piecewise Cubic Hermite Interpolating Polynomial)** создаёт плавные кривые, которые:
- Проходят точно через все контрольные точки
- Имеют непрерывные первые производные (плавность)
- **Без выбросов или пульсаций** между контрольными точками (монотонность)

Предотвращает искусственное падения компенсации (например, 0.998x, когда должно быть 1.000x), которые возникают при использовании естественных кубических сплайнов.

## Пример вывода

### Режим одной головки
```
Parsing: test_model.gcode
Detected metadata:
  Filament type:    PETG
  Filament diameter: 1.75 mm
  Layer height:     0.2 mm
  Line width:       0.4 mm
Using material profile: PETG
Filament diameter: 1.75 mm, area: 2.4053 mm²

Processing 15234 lines...
Using parser: library

============================================================
FLOW COMPENSATION STATISTICS
============================================================
Total extrusion moves:     12458
Compensated moves:         3842 (30.8%)

Flow rate range:           2.3 - 52.7 mm³/s
Average flow rate:         18.4 mm³/s

Multiplier range:          1.000 - 1.132x
============================================================
```

### Режим мульти-материала IDEX
```
Parsing: multi_material_model.gcode
Detected metadata:
  Filament type:    PETG
  Filament diameter: 1.75 mm
  Layer height:     0.2 mm
Multi-material setup from command line: 2 tools
  T0: PETG
  T1: PVA
Tool T0: Using material profile: PETG
Tool T1: Using material profile: PVA

Multi-material mode enabled
Filament diameter: 1.75 mm, area: 2.4053 mm²

Processing 28456 lines...

============================================================
FLOW COMPENSATION STATISTICS
============================================================

Tool T0 (PETG):
  Total moves:     18234
  Compensated:     5621 (30.8%)
  Flow range:      2.3 - 52.7 mm3/s
  Avg flow:        18.4 mm3/s
  Multiplier:      1.000 - 1.132x

Tool T1 (PVA):
  Total moves:     4212
  Compensated:     1248 (29.6%)
  Flow range:      1.8 - 15.2 mm3/s
  Avg flow:        8.7 mm3/s
  Multiplier:      1.000 - 1.085x

Total: 22446 moves, 6869 compensated (30.6%)
============================================================
```

## Решение проблем

### Скрипт не найден в Prusa Slicer

Используйте полные пути:
```
C:\Python311\python.exe "C:\flow-compensator\flow_compensator.py" --config "C:\flow-compensator\config.yaml" "[output_filepath]"
```

### Материал не обнаружен

Убедитесь, что G-код содержит `; filament_type = PETG` в заголовке. Prusa Slicer добавляет это автоматически. Если отсутствует, используется профиль `default`.

### Перэкструзия

Точки кривой слишком агрессивные:
1. Уменьшите множители на 5-10%
2. Сделайте тестовую печать и измерьте недоэкструзию
3. Настройте предел `max_compensation`

### Недостаточная экструзия сохраняется

Точки кривой слишком консервативные:
1. Постепенно увеличьте множители (+5%)
2. Сделайте тест скорости потока для измерения реальной недоэкструзии
3. Создайте собственные точки кривой

## Технические детали

- **Время обработки**: ~1-2 секунды для файлов G-код на 20,000 строк
- **Слайсеры**: Prusa Slicer, SuperSlicer, Orca Slicer (любые с комментариями в стиле Prusa)
- **Платформы**: Windows, Linux, macOS
- **Python**: 3.7+
- **Парсеры**: Доступны режимы Library (gcodeparser) и Regex
- **Мульти-материал**: Полная поддержка систем IDEX и toolchanger

## Файлы

- `flow_compensator.py` - Основной скрипт
- `config.yaml` - Профили материалов по умолчанию (создайте свой из config_template.yaml)
- `config_template.yaml` - Шаблон с подробной документацией
- `requirements.txt` - Зависимости Python

## Благодарности

Особая благодарность:
- **Дмитрию Соркину** за идею и вдохновение
- **Сообществу K3D**

Создано для решения проблем недостаточной экструзии с высокоскоростными хотендами, такими как Goliath, Rapido HF и подобным хотендам.

## Лицензия

MIT License - Не стесняйтесь модифицировать и распространять.

## Тестирование

Запустите набор тестов для проверки установки и правильности кода:

```bash
# Запустить все тесты
python test_flow_compensator.py -v

# Запустить конкретный класс тестов
python -m unittest test_flow_compensator.TestGCodeParser -v

# Запустить конкретный метод теста
python -m unittest test_flow_compensator.TestGCodeParser.test_parse_metadata -v
```

## Contributing

 Contributions приветствуются! Тестируйте с различными материалами и хотендами, делитесь данными о кривых компенсации, сообщайте об ошибках или предлагайте улучшения.
